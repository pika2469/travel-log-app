import"./style-DDcRjs_y.js";function b(){if(localStorage.getItem("cityProvinceLocationMapping")){console.log("キャッシュはすでに存在しています");return}const t="/travel-log-app".endsWith("/")?"/travel-log-app":"/travel-log-app/";fetch(`${t}china_cities.csv`).then(c=>c.text()).then(c=>{const e={},r=c.split(`
`),h=r[0].split(",").map(g=>g.trim());for(let g=1;g<r.length;g++){const f=r[g].split(",").map(d=>d.trim());if(f.length!==h.length)continue;const s={};h.forEach((d,u)=>{s[d]=f[u]});const l=s.city_name_zh,i=s.city_name_zh2,a=s.province_name_zh,p=s.province_name_en,o=parseFloat(s.Latitude),n=parseFloat(s.Longitude);l&&(e[l]={province_zh:a,province_en:p,lat:o,lon:n}),i&&(e[i]={province_zh:a,province_en:p,lat:o,lon:n})}localStorage.setItem("cityProvinceLocationMapping",JSON.stringify(e)),console.log("map.js側で都市と省のキャッシュを初期化しました")}).catch(c=>console.error("csvの読込に失敗しました:",c))}function m(t){t.eachLayer(c=>t.removeLayer(c)),L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{className:"leaflet-dark-bg",attribution:"© OpenStreetMap contributors, © CARTO"}).addTo(t)}function S(t,c){L.geoJSON(c,{style:{fillColor:"#111",stroke:!1,fillOpacity:1},interactive:!1}).addTo(t)}function w(t,c,e){S(t,e),L.geoJSON(e,{style:r=>{var g;const h=(g=r.id)==null?void 0:g.toUpperCase();return c.includes(h)?{fillColor:"#a7d8ff",color:"#5eaada",weight:1,fillOpacity:.3}:{fillColor:"#111",stroke:!1,fillOpacity:1}},onEachFeature:(r,h)=>{var l;const g=JSON.parse(localStorage.getItem("travelLogs")||"[]"),f=(l=r.id)==null?void 0:l.toUpperCase(),s=g.filter(i=>i.country===f);s.length>0&&h.on("click",i=>{x(i.originalEvent,s)})}}).addTo(t)}function E(t,c,e){S(t,c);const r=JSON.parse(localStorage.getItem("travelLogs")||"[]"),h=JSON.parse(localStorage.getItem("cityProvinceLocationMapping")||"{}"),g=new Set,f=[];r.forEach(l=>{if(!l.location.includes("中国"))return;const i=l.location.split("、")[0],a=h[i];if(!a)return;const{lat:p,lon:o,province_zh:n,province_en:d}=a;g.add(d),p&&o&&f.push({lat:p,lon:o,city:i,province_zh:n})});const s=L.geoJSON(e,{style:l=>{const i=l.properties.name;return g.has(i)?{fillColor:"#a7d8ff",color:"#5eaada",weight:1,fillOpacity:.3}:{fillColor:"#222",color:"#333",weight:.5,fillOpacity:.2}},onEachFeature:(l,i)=>{i.on("click",a=>{const p=l.properties.name,o=r.filter(n=>{const d=n.location.split("、")[0],u=h[d];return u&&u.province_en===p});x(a.originalEvent,o)})}}).addTo(t);t.fitBounds(s.getBounds()),f.forEach(({lat:l,lon:i,city:a,province_zh:p})=>{L.circleMarker([l,i],{radius:3,fillColor:"#0057b7",color:"#003f88",weight:1,opacitiy:1,fillOpacity:.9}).addTo(t).bindPopup(`<strong>${a}</strong><br>${p}`)})}function x(t,c){let e=document.getElementById("info-popup");if(e&&e.remove(),c.length===0)return;e=document.createElement("div"),e.id="info-popup",e.style.position="absolute",e.style.backgroundColor="rgba(15,15,20,0.6)",e.style.border="1px solid rgba(255, 255, 255, 0.2)",e.style.color="white",e.style.borderRadius="12px",e.style.padding="10px",e.style.MaxWidth="300px",e.style.maxHeight="300px",e.style.overflowY="auto",e.style.display="flex",e.style.flexDirection="column",e.style.gap="10px",e.style.backdropFilter="blur(8px)",e.style.zIndex=1e3,e.style.boxShadow="0 4px 12px rgba(0,0,0,0.5)",e.style.fontSize="0.8rem",document.body.appendChild(e),c.forEach(i=>{const a=document.createElement("div");a.className="log-card",a.style.backgorundColor="rgba(255, 255, 255, 0.05)",a.style.color="white",a.style.padding="8px",a.style.borderRadius="8px",a.style.border="1px solid rgba(255,255,255,0.1)",a.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)";const p=document.createElement("div");p.style.display="flex",p.style.gap="8px",p.style.flexWrap="wrap",p.style.alignItems="center",p.style.lineHeight="1.4";const o=document.createElement("span");o.textContent=i.date;const n=document.createElement("span");n.textContent=i.location.split("、")[0],p.appendChild(o),p.appendChild(n),a.appendChild(p),e.appendChild(a)});const r=10,{innerWidth:h,innerHeight:g}=window,f=e.getBoundingClientRect();let s=t.x,l=t.y;s+f.width+r>h&&(s=h-f.width-r),l+f.height+r>g&&(l=g-f.height-r),s<r&&(s=r),l<r&&(l=r),e.style.left=`${s}px`,e.style.top=`${l}px`,setTimeout(()=>{document.addEventListener("click",function i(a){e.contains(a.target)||(e.remove(),document.removeEventListener("click",i))})},10)}function O(){const t=JSON.parse(localStorage.getItem("travelLogs")||"[]"),c=new Set;return t.forEach(e=>{e.country&&c.add(e.country.toUpperCase())}),Array.from(c)}b();document.addEventListener("DOMContentLoaded",async()=>{const t=L.map("map",{zoomControl:!1});m(t);const c="/travel-log-app".endsWith("/")?"/travel-log-app":"/travel-log-app/",[e,r]=await Promise.all([fetch(`${c}world-110m.geojson`).then(o=>o.json()),fetch(`${c}china-province.geojson`).then(o=>o.json())]),h=document.createElement("div");h.id="info-panel",document.body.appendChild(h);const g=document.querySelectorAll("[data-mode]");let f="";g.forEach(o=>{o.addEventListener("click",()=>{const n=o.dataset.mode;switch(f=n,g.forEach(d=>d.classList.remove("active")),o.classList.add("active"),m(t),n){case"world":t.setView([36.2048,138.2529],2),m(t);const d=O();w(t,d,e);break;case"china":E(t,e,r);break;case"japan":t.setView([36.2048,138.2539],5),m(t);break}})});function s(o){return JSON.parse(localStorage.getItem("locationCache")||"{}")[o]||null}function l(o,n,d){const u=JSON.parse(localStorage.getItem("locationCache")||"{}");u[o]={lat:n,lon:d},localStorage.setItem("locationCache",JSON.stringify(u))}const i=JSON.parse(localStorage.getItem("travelLogs")||"[]"),a=L.latLngBounds(),p=i.map(o=>{const n=o.location,d=s(n);if(d)return console.log(`キャッシュヒット: ${n}`),Promise.resolve({lat:d.lat,lon:d.lon,log:o});console.log(`キャッシュミス: ${n}`);const u=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}`;return fetch(u).then(y=>y.json()).then(y=>{if(!y||y.length===0)return console.error(`位置情報が見つかりませんでした: ${n}`),{lat:null,lon:null,log:o};const v=parseFloat(y[0].lat),C=parseFloat(y[0].lon);return l(n,v,C),{lat:v,lon:C,log:o}}).catch(y=>(console.error(`位置情報取得失敗: ${n}`,y),null))});Promise.all(p).then(o=>{f!=="world"&&o.forEach(n=>{if(n){const{lat:d,lon:u,log:y}=n;L.circleMarker([d,u],{radius:5,color:"#3366cc",fillColor:"#4a90e2",fillOpacity:.8}).addTo(t),a.extend([d,u])}})}),document.querySelector('button[data-mode="china"]').click()});
