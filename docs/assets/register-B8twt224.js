import"./style-DDcRjs_y.js";document.addEventListener("DOMContentLoaded",async()=>{await R();const v=document.getElementById("register-form"),u=document.getElementById("log-list"),h=document.getElementById("modal-root");g(),v.addEventListener("submit",async e=>{e.preventDefault();const c=new FormData(v),t=c.get("date"),a=c.get("title"),n=c.get("location"),o=c.get("memo"),s=n.split(/[、,]/)[0].trim(),i=localStorage.getItem("cityProvinceLocationMapping")||"{}",l=JSON.parse(i)[s];let r=null,d=null,p=null,x=null;if(l)r=l.province_zh,d=l.province_en,p=l.lat,x=l.lon;else if(!confirm("この都市はデータベースに存在しません。マッピングはできませんが、記録は続けますか？"))return;let L="UNK";try{const C=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}&addressdetails=1`,f=await(await fetch(C)).json();if(f.length>0&&f[0].address&&f[0].address.country_code){const w=f[0].address.country_code.toUpperCase();L=T(w)||w}}catch(C){console.error("国コードの取得に失敗しました",C);return}const M={id:Date.now(),date:t,title:a,location:n,memo:o,country:L,province_zh:r,province_en:d,lat:p,lon:x},b=JSON.parse(localStorage.getItem("travelLogs")||"[]");b.push(M),localStorage.setItem("travelLogs",JSON.stringify(b)),v.reset(),g()});function g(){const e=JSON.parse(localStorage.getItem("travelLogs")||"[]");e.sort((t,a)=>new Date(a.date)-new Date(t.date)),u.innerHTML="",u.className="flex flex-col gap-2";const c=document.createElement("div");c.className="h-6",u.appendChild(c),e.forEach(t=>{const a=document.createElement("div");a.className=`
        bg-white/10 backdrop-blur rounded-xl p-4 flex flex-col gap-2
        shadow border border-white/20 text-white/80
      `;const n=document.createElement("div");n.className="flex justify-between items-center";const o=document.createElement("h3");o.className="text-white font-semibold text-base",o.textContent=t.title;const s=document.createElement("span");s.className="text-sm text-white/60",s.textContent=t.date,n.appendChild(o),n.appendChild(s);const i=document.createElement("div");i.className="text-sm text-white/70",i.innerHTML=`<strong>場所：</strong> ${t.location}`;const m=document.createElement("div");m.className="text-sm text-white/60",m.textContent=t.memo?t.memo:"No data";const l=document.createElement("div");l.className="flex gap-2 mt-2";const r=document.createElement("button");r.textContent="編集",r.className="bg-blue-600 hover:bg-blue-500 text-white rounded px-3 py-1 text-sm transition",r.addEventListener("click",()=>J(t));const d=document.createElement("button");d.textContent="削除",d.className="bg-red-600 hover:bg-red-500 text-white rounded px-3 py-1 text-sm transition",d.addEventListener("click",()=>E(t.id,t.location)),l.appendChild(r),l.appendChild(d),a.appendChild(n),a.appendChild(i),a.appendChild(m),a.appendChild(l),u.appendChild(a)})}function E(e,c,t=!1){if(!t&&!confirm("本当にこの記録を削除しますか？"))return;const a=JSON.parse(localStorage.getItem("locationCache")||"{}");delete a[c],localStorage.setItem("locationCache",JSON.stringify(a));const n=D().filter(o=>o.id!==e);O(n),g()}function J(e){h.innerHTML="";const c=document.createElement("div");c.className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50",c.addEventListener("click",x=>{x.target===c&&N()});const t=document.createElement("div");t.className="bg-[#1f1f1f] rounded-xl p-6 max-w-sm w-full shadow-lg relative";const a=document.createElement("h2");a.className="text-lg font-bold mb-4 text-white/90",a.textContent="記録を編集";const n=document.createElement("form");n.className="flex flex-col gap-3";const o=document.createElement("input");o.type="date",o.name="date",o.value=e.date,o.required=!0,o.className="bg-white/10 backdrop-blur rounded-lg px-4 py-2 text-white/80 focus:ring focus:ring-blue-600 transition";const s=document.createElement("input");s.type="text",s.name="title",s.value=e.title,s.required=!0,s.className=o.className;const i=document.createElement("input");i.type="text",i.name="location",i.value=e.location,i.required=!0,i.className=o.className;const m=document.createElement("textarea");m.name="memo",m.rows=3,m.textContent=e.memo||"",m.className=o.className;const l=document.createElement("div");l.className="flex justify-end gap-2 mt-3";const r=document.createElement("button");r.textContent="削除",r.className="bg-red-600 hover:bg-red-500 text-white rounded px-4 py-2 text-sm transition",r.addEventListener("click",()=>{confirm("本当に削除しますか？")&&(E(e.id,e.location,!0),N())});const d=document.createElement("button");d.type="submit",d.textContent="保存",d.className="bg-blue-600 hover:bg-blue-500 text-white rounded px-4 py-2 text-sm transition",l.appendChild(d),l.appendChild(r),n.appendChild(o),n.appendChild(s),n.appendChild(i),n.appendChild(m),n.appendChild(l),n.addEventListener("submit",x=>{x.preventDefault();const L=o.value,M=s.value,b=i.value,C=m.value;let I=e.province_zh,f=e.province_en,w=e.lat,k=e.lon;if(b!==e.location){const S=b.split(/[、,]/)[0].trim(),P=localStorage.getItem("cityProvinceLocationMapping")||"{}",y=JSON.parse(P)[S];if(y)I=y.province_zh,f=y.province_en,w=y.lat,k=y.lon;else{alert("指定した都市がデータベースにありません。csvを更新してください。");return}}const B={...e,date:L,title:M,location:b,memo:C,province_zh:I,province_en:f,lat:w,lon:k},j=D().map(S=>S.id===e.id?B:S);O(j),N(),g()});const p=document.createElement("button");p.id="close-modal",p.className="absolute top-2 right-2 text-white/50 hover:text-white text-xl",p.innerHTML="&times;",p.addEventListener("click",N),t.appendChild(a),t.appendChild(n),t.appendChild(p),c.appendChild(t),h.appendChild(c)}function N(){h.innerHTML=""}function D(){return JSON.parse(localStorage.getItem("travelLogs")||"[]")}function O(e){localStorage.setItem("travelLogs",JSON.stringify(e))}});let _={};function R(){const u=`${"/travel-log-app".endsWith("/")?"/travel-log-app":"/travel-log-app/"}codes.json`;return console.log(`Loading country code map from: ${u}`),fetch(u).then(h=>h.json()).then(h=>{_={},h.forEach(([g,E])=>{_[g]=E})})}function T(v){return _[v.toUpperCase()]||null}
