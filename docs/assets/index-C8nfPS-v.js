import"./style-BUm7X4p0.js";function I(){if(localStorage.getItem("cityProvinceLocationMapping")){console.log("キャッシュはすでに存在しています");return}fetch("/travel-log-app/china_cities.csv").then(t=>t.text()).then(t=>{const a={},e=t.split(`
`),u=e[0].split(",").map(p=>p.trim());for(let p=1;p<e.length;p++){const i=e[p].split(",").map(r=>r.trim());if(i.length!==u.length)continue;const n={};u.forEach((r,y)=>{n[r]=i[y]});const s=n.city_name_zh,g=n.city_name_zh2,o=n.province_name_zh,c=n.province_name_en,l=parseFloat(n.Latitude),d=parseFloat(n.Longitude);s&&(a[s]={province_zh:o,province_en:c,lat:l,lon:d}),g&&(a[g]={province_zh:o,province_en:c,lat:l,lon:d})}localStorage.setItem("cityProvinceLocationMapping",JSON.stringify(a)),console.log("map.js側で都市と省のキャッシュを初期化しました")}).catch(t=>console.error("csvの読込に失敗しました:",t))}function E(t){t.eachLayer(a=>{t.removeLayer(a)}),L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors, © CARTO"}).addTo(t)}function b(t,a){let e=document.getElementById("info-popup");if(e&&e.remove(),a.length===0)return;e=document.createElement("div"),e.id="info-popup",e.style.position="absolute",e.style.backgroundColor="rgba(0,0,0,0.85)",e.style.border="1px solid #444",e.style.color="white",e.style.borderRadius="8px",e.style.padding="10px",e.style.MaxWidth="90%",e.style.maxHeight="300px",e.style.overflowY="auto",e.style.display="flex",e.style.flexDirection="column",e.style.gap="10px",e.style.zIndex=1e3,document.body.appendChild(e);const{x:u,y:p}=t;e.style.left=`${u}px`,e.style.top=`${p}px`,a.forEach(i=>{const n=document.createElement("div");n.className="log-card",n.style.backgorundColor="#4a90e2",n.style.color="black",n.style.padding="10px",n.style.borderRadius="6px";const s=document.createElement("div");s.style.display="flex",s.style.gap="10px",s.style.alignItems="center";const g=document.createElement("span");g.textContent=i.date;const o=document.createElement("span");o.textContent=i.location.split("、")[0],s.appendChild(g),s.appendChild(o),n.appendChild(s),e.appendChild(n)}),setTimeout(()=>{document.addEventListener("click",function i(n){e.contains(n.target)||(e.remove(),document.removeEventListener("click",i))})},10)}I();document.addEventListener("DOMContentLoaded",()=>{const t=L.map("map").setView([36.2048,138.2529],2);E(t);const a=document.createElement("div");a.id="info-panel",document.body.appendChild(a);const e=document.querySelectorAll(".mode-buttons button");let u="";e.forEach(o=>{o.addEventListener("click",()=>{const c=o.dataset.mode;switch(u=c,e.forEach(l=>l.classList.remove("active")),o.classList.add("active"),c){case"world":t.setView([36.2048,138.2529],2),E(t);const l=M();N(t,l);break;case"china":t.setView([35.817,104.1954],4),E(t);const d=JSON.parse(localStorage.getItem("travelLogs")||"[]"),r=JSON.parse(localStorage.getItem("cityProvinceLocationMapping")||"{}"),y=new Set,C=[];d.forEach(h=>{if(!h.location.includes("中国"))return;const m=h.location.split("、")[0],f=r[m];if(!f)return;const{lat:v,lon:S,province_zh:x,province_en:O}=f;y.add(O),v&&S&&C.push({lat:v,lon:S,city:m,province_zh:x})}),C.forEach(({lat:h,lon:m,city:f,province_zh:v})=>{L.circleMarker([h,m],{radius:6,fillColor:"#4a90e2",color:"#3366cc",weight:1,opacitiy:1,fillOpacity:.6}).addTo(t).bindPopup(`<strong>${f}</strong><br>${v}`)}),fetch("/travel-log-app/china-province.geojson").then(h=>h.json()).then(h=>{L.geoJSON(h,{style:m=>{const f=m.properties.name;return y.has(f)?{fillColor:"#4a90e2",color:"#3366cc",weight:1,fillOpacity:.6}:{fillColor:"#e0e0e0",color:"#cccccc",weight:.5,fillOpacity:.2}},onEachFeature:(m,f)=>{f.on("click",v=>{const S=m.properties.name,x=d.filter(O=>{const _=O.location.split("、")[0],w=r[_];return w&&w.province_en===S});b(v.originalEvent,x)})}}).addTo(t)}).catch(h=>{console.error("中国地図のGeoJSON読込に失敗しました:",h)}),console.log("中国地図がtravelLogsに基いてGeoJSONで描画されました");break;case"japan":t.setView([36.2048,138.2539],5),E(t);break}})});function p(o){return JSON.parse(localStorage.getItem("locationCache")||"{}")[o]||null}function i(o,c,l){const d=JSON.parse(localStorage.getItem("locationCache")||"{}");d[o]={lat:c,lon:l},localStorage.setItem("locationCache",JSON.stringify(d))}const n=JSON.parse(localStorage.getItem("travelLogs")||"[]"),s=L.latLngBounds(),g=n.map(o=>{const c=o.location,l=p(c);if(l)return console.log(`キャッシュヒット: ${c}`),Promise.resolve({lat:l.lat,lon:l.lon,log:o});console.log(`キャッシュミス: ${c}`);const d=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(c)}`;return fetch(d).then(r=>r.json()).then(r=>{if(!r||r.length===0)return console.error(`位置情報が見つかりませんでした: ${c}`),{lat:null,lon:null,log:o};const y=parseFloat(r[0].lat),C=parseFloat(r[0].lon);return i(c,y,C),{lat:y,lon:C,log:o}}).catch(r=>(console.error(`位置情報取得失敗: ${c}`,r),null))});Promise.all(g).then(o=>{u!=="world"&&o.forEach(c=>{if(c){const{lat:l,lon:d,log:r}=c;L.circleMarker([l,d],{radius:5,color:"#3366cc",fillColor:"#4a90e2",fillOpacity:.8}).addTo(t),s.extend([l,d])}})})});function N(t,a){fetch("/travel-log-app/world-110m.geojson").then(e=>e.json()).then(e=>{L.geoJSON(e,{style:u=>{var i;const p=(i=u.id)==null?void 0:i.toUpperCase();return a.includes(p)?{fillColor:"#4a90e2",color:"#3366cc",weight:1,fillOpacity:.6}:{fillColor:"#e0e0e0",color:"#cccccc",weight:.5,fillOpacity:.2}},onEachFeature:(u,p)=>{var g;const i=JSON.parse(localStorage.getItem("travelLogs")||"[]"),n=(g=u.id)==null?void 0:g.toUpperCase(),s=i.filter(o=>o.country===n);s.length>0&&p.on("click",o=>{b(o.originalEvent,s)})}}).addTo(t)}).catch(e=>{console.error("世界地図の読み込みに失敗しました:",e)})}function M(){const t=JSON.parse(localStorage.getItem("travelLogs")||"[]"),a=new Set;return t.forEach(e=>{e.country&&a.add(e.country.toUpperCase())}),Array.from(a)}
