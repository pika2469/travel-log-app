import"./style-DDcRjs_y.js";function b(){localStorage.removeItem("cityProvinceLocationMapping");const t="/travel-log-app".endsWith("/")?"/travel-log-app":"/travel-log-app/";fetch(`${t}china_cities.csv`).then(i=>i.text()).then(i=>{const e={},s=i.split(`
`).map(a=>a.trim()).filter(a=>a.length>0),f=s[0].split(",").map(a=>a.trim());for(let a=1;a<s.length;a++){const g=s[a].split(",").map(h=>h.trim());if(g.length!==f.length)continue;const p={};f.forEach((h,u)=>{p[h]=g[u]});const l=p.city_name_zh,r=p.city_name_zh2,c=p.province_name_zh,d=p.province_name_en,o=parseFloat(p.Latitude),n=parseFloat(p.Longitude);l&&(e[l]={province_zh:c,province_en:d,lat:o,lon:n}),r&&(e[r]={province_zh:c,province_en:d,lat:o,lon:n})}localStorage.setItem("cityProvinceLocationMapping",JSON.stringify(e)),console.log("map.js側で都市と省のキャッシュを初期化しました")}).catch(i=>console.error("csvの読込に失敗しました:",i))}function y(t){t.eachLayer(i=>t.removeLayer(i)),L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{className:"leaflet-dark-bg",attribution:"© OpenStreetMap contributors, © CARTO"}).addTo(t)}function S(t,i){L.geoJSON(i,{style:{fillColor:"#111",stroke:!1,fillOpacity:1},interactive:!1}).addTo(t)}function w(t,i,e){S(t,e),L.geoJSON(e,{style:s=>{var a;const f=(a=s.id)==null?void 0:a.toUpperCase();return i.includes(f)?{fillColor:"#a7d8ff",color:"#5eaada",weight:1,fillOpacity:.3}:{fillColor:"#111",stroke:!1,fillOpacity:1}},onEachFeature:(s,f)=>{var l;const a=JSON.parse(localStorage.getItem("travelLogs")||"[]"),g=(l=s.id)==null?void 0:l.toUpperCase(),p=a.filter(r=>r.country===g);p.length>0&&f.on("click",r=>{x(r.originalEvent,p)})}}).addTo(t)}function E(t,i,e){S(t,i);const s=JSON.parse(localStorage.getItem("travelLogs")||"[]"),f=JSON.parse(localStorage.getItem("cityProvinceLocationMapping")||"{}"),a=new Set,g=[];s.forEach(l=>{if(!l.location.includes("中国"))return;const r=l.location.split("、")[0],c=f[r];if(!c)return;const{lat:d,lon:o,province_zh:n,province_en:h}=c;a.add(h),d&&o&&g.push({lat:d,lon:o,city:r,province_zh:n})});const p=L.geoJSON(e,{style:l=>{const r=l.properties.name;return a.has(r)?{fillColor:"#a7d8ff",color:"#5eaada",weight:1,fillOpacity:.3}:{fillColor:"#222",color:"#333",weight:.5,fillOpacity:.2}},onEachFeature:(l,r)=>{r.on("click",c=>{const d=l.properties.name,o=s.filter(n=>{const h=n.location.split("、")[0],u=f[h];return u&&u.province_en===d});x(c.originalEvent,o)})}}).addTo(t);t.fitBounds(p.getBounds()),g.forEach(({lat:l,lon:r,city:c,province_zh:d})=>{L.circleMarker([l,r],{radius:3,fillColor:"#0057b7",color:"#003f88",weight:1,opacitiy:1,fillOpacity:.9}).addTo(t).bindPopup(`<strong>${c}</strong><br>${d}`)})}function x(t,i){let e=document.getElementById("info-popup");if(e&&e.remove(),i.length===0)return;e=document.createElement("div"),e.id="info-popup",e.style.position="absolute",e.style.backgroundColor="rgba(15,15,20,0.6)",e.style.border="1px solid rgba(255, 255, 255, 0.2)",e.style.color="white",e.style.borderRadius="12px",e.style.padding="10px",e.style.MaxWidth="300px",e.style.maxHeight="300px",e.style.overflowY="auto",e.style.display="flex",e.style.flexDirection="column",e.style.gap="10px",e.style.backdropFilter="blur(8px)",e.style.zIndex=1e3,e.style.boxShadow="0 4px 12px rgba(0,0,0,0.5)",e.style.fontSize="0.8rem",document.body.appendChild(e),i.forEach(r=>{const c=document.createElement("div");c.className="log-card",c.style.backgorundColor="rgba(255, 255, 255, 0.05)",c.style.color="white",c.style.padding="8px",c.style.borderRadius="8px",c.style.border="1px solid rgba(255,255,255,0.1)",c.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)";const d=document.createElement("div");d.style.display="flex",d.style.gap="8px",d.style.flexWrap="wrap",d.style.alignItems="center",d.style.lineHeight="1.4";const o=document.createElement("span");o.textContent=r.date;const n=document.createElement("span");n.textContent=r.location.split("、")[0],d.appendChild(o),d.appendChild(n),c.appendChild(d),e.appendChild(c)});const s=10,{innerWidth:f,innerHeight:a}=window,g=e.getBoundingClientRect();let p=t.x,l=t.y;p+g.width+s>f&&(p=f-g.width-s),l+g.height+s>a&&(l=a-g.height-s),p<s&&(p=s),l<s&&(l=s),e.style.left=`${p}px`,e.style.top=`${l}px`,setTimeout(()=>{document.addEventListener("click",function r(c){e.contains(c.target)||(e.remove(),document.removeEventListener("click",r))})},10)}function O(){const t=JSON.parse(localStorage.getItem("travelLogs")||"[]"),i=new Set;return t.forEach(e=>{e.country&&i.add(e.country.toUpperCase())}),Array.from(i)}b();document.addEventListener("DOMContentLoaded",async()=>{const t=L.map("map",{zoomControl:!1});y(t);const i="/travel-log-app".endsWith("/")?"/travel-log-app":"/travel-log-app/",[e,s]=await Promise.all([fetch(`${i}world-110m.geojson`).then(o=>o.json()),fetch(`${i}china-province.geojson`).then(o=>o.json())]),f=document.createElement("div");f.id="info-panel",document.body.appendChild(f);const a=document.querySelectorAll("[data-mode]");let g="";a.forEach(o=>{o.addEventListener("click",()=>{const n=o.dataset.mode;switch(g=n,a.forEach(h=>h.classList.remove("active")),o.classList.add("active"),y(t),n){case"world":t.setView([36.2048,138.2529],2),y(t);const h=O();w(t,h,e);break;case"china":E(t,e,s);break;case"japan":t.setView([36.2048,138.2539],5),y(t);break}})});function p(o){return JSON.parse(localStorage.getItem("locationCache")||"{}")[o]||null}function l(o,n,h){const u=JSON.parse(localStorage.getItem("locationCache")||"{}");u[o]={lat:n,lon:h},localStorage.setItem("locationCache",JSON.stringify(u))}const r=JSON.parse(localStorage.getItem("travelLogs")||"[]"),c=L.latLngBounds(),d=r.map(o=>{const n=o.location,h=p(n);if(h)return Promise.resolve({lat:h.lat,lon:h.lon,log:o});console.log(`キャッシュミス: ${n}`);const u=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}`;return fetch(u).then(m=>m.json()).then(m=>{if(!m||m.length===0)return console.error(`位置情報が見つかりませんでした: ${n}`),{lat:null,lon:null,log:o};const v=parseFloat(m[0].lat),C=parseFloat(m[0].lon);return l(n,v,C),{lat:v,lon:C,log:o}}).catch(m=>(console.error(`位置情報取得失敗: ${n}`,m),null))});Promise.all(d).then(o=>{g!=="world"&&o.forEach(n=>{if(n){const{lat:h,lon:u,log:m}=n;L.circleMarker([h,u],{radius:5,color:"#3366cc",fillColor:"#4a90e2",fillOpacity:.8}).addTo(t),c.extend([h,u])}})}),document.querySelector('button[data-mode="china"]').click()});
