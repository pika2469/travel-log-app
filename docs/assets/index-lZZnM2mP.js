import"./style-B9Z0z9bF.js";function P(){if(localStorage.getItem("cityProvinceLocationMapping")){console.log("キャッシュはすでに存在しています");return}const t="/travel-log-app".endsWith("/")?"/travel-log-app":"/travel-log-app/";fetch(`${t}china_cities.csv`).then(a=>a.text()).then(a=>{const e={},p=a.split(`
`),h=p[0].split(",").map(r=>r.trim());for(let r=1;r<p.length;r++){const c=p[r].split(",").map(f=>f.trim());if(c.length!==h.length)continue;const l={};h.forEach((f,v)=>{l[f]=c[v]});const g=l.city_name_zh,o=l.city_name_zh2,n=l.province_name_zh,i=l.province_name_en,d=parseFloat(l.Latitude),s=parseFloat(l.Longitude);g&&(e[g]={province_zh:n,province_en:i,lat:d,lon:s}),o&&(e[o]={province_zh:n,province_en:i,lat:d,lon:s})}localStorage.setItem("cityProvinceLocationMapping",JSON.stringify(e)),console.log("map.js側で都市と省のキャッシュを初期化しました")}).catch(a=>console.error("csvの読込に失敗しました:",a))}function E(t){t.eachLayer(a=>{t.removeLayer(a)}),L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors, © CARTO"}).addTo(t)}function b(t,a){let e=document.getElementById("info-popup");if(e&&e.remove(),a.length===0)return;e=document.createElement("div"),e.id="info-popup",e.style.position="absolute",e.style.backgroundColor="rgba(0,0,0,0.85)",e.style.border="1px solid #444",e.style.color="white",e.style.borderRadius="8px",e.style.padding="10px",e.style.MaxWidth="90%",e.style.maxHeight="300px",e.style.overflowY="auto",e.style.display="flex",e.style.flexDirection="column",e.style.gap="10px",e.style.zIndex=1e3,document.body.appendChild(e);const{x:p,y:h}=t;e.style.left=`${p}px`,e.style.top=`${h}px`,a.forEach(r=>{const c=document.createElement("div");c.className="log-card",c.style.backgorundColor="#4a90e2",c.style.color="white",c.style.padding="10px",c.style.borderRadius="6px";const l=document.createElement("div");l.style.display="flex",l.style.gap="10px",l.style.alignItems="center";const g=document.createElement("span");g.textContent=r.date;const o=document.createElement("span");o.textContent=r.location.split("、")[0],l.appendChild(g),l.appendChild(o),c.appendChild(l),e.appendChild(c)}),setTimeout(()=>{document.addEventListener("click",function r(c){e.contains(c.target)||(e.remove(),document.removeEventListener("click",r))})},10)}P();document.addEventListener("DOMContentLoaded",()=>{const t=L.map("map").setView([36.2048,138.2529],2);E(t);const a=document.createElement("div");a.id="info-panel",document.body.appendChild(a);const e=document.querySelectorAll("[data-mode]");let p="";e.forEach(o=>{o.addEventListener("click",()=>{const n=o.dataset.mode;switch(p=n,e.forEach(i=>i.classList.remove("active")),o.classList.add("active"),n){case"world":t.setView([36.2048,138.2529],2),E(t);const i=J();M(t,i);break;case"china":t.setView([35.817,104.1954],4),E(t);const d=JSON.parse(localStorage.getItem("travelLogs")||"[]"),s=JSON.parse(localStorage.getItem("cityProvinceLocationMapping")||"{}"),f=new Set,v=[];d.forEach(u=>{if(!u.location.includes("中国"))return;const C=u.location.split("、")[0],m=s[C];if(!m)return;const{lat:y,lon:S,province_zh:x,province_en:O}=m;f.add(O),y&&S&&v.push({lat:y,lon:S,city:C,province_zh:x})}),v.forEach(({lat:u,lon:C,city:m,province_zh:y})=>{L.circleMarker([u,C],{radius:3,fillColor:"#0057b7",color:"#003f88",weight:1,opacitiy:1,fillOpacity:.9}).addTo(t).bindPopup(`<strong>${m}</strong><br>${y}`)});const _="/travel-log-app".endsWith("/")?"/travel-log-app":"/travel-log-app/";fetch(`${_}china-province.geojson`).then(u=>u.json()).then(u=>{const C=L.geoJSON(u,{style:m=>{const y=m.properties.name;return f.has(y)?{fillColor:"#a7d8ff",color:"#5eaada",weight:1,fillOpacity:.3}:{fillColor:"#e0e0e0",color:"#cccccc",weight:.5,fillOpacity:.2}},onEachFeature:(m,y)=>{y.on("click",S=>{const x=m.properties.name,O=d.filter(I=>{const N=I.location.split("、")[0],w=s[N];return w&&w.province_en===x});b(S.originalEvent,O)})}}).addTo(t);t.fitBounds(C.getBounds())}).catch(u=>{console.error("中国地図のGeoJSON読込に失敗しました:",u)}),console.log("中国地図がtravelLogsに基いてGeoJSONで描画されました");break;case"japan":t.setView([36.2048,138.2539],5),E(t);break}})});function h(o){return JSON.parse(localStorage.getItem("locationCache")||"{}")[o]||null}function r(o,n,i){const d=JSON.parse(localStorage.getItem("locationCache")||"{}");d[o]={lat:n,lon:i},localStorage.setItem("locationCache",JSON.stringify(d))}const c=JSON.parse(localStorage.getItem("travelLogs")||"[]"),l=L.latLngBounds(),g=c.map(o=>{const n=o.location,i=h(n);if(i)return console.log(`キャッシュヒット: ${n}`),Promise.resolve({lat:i.lat,lon:i.lon,log:o});console.log(`キャッシュミス: ${n}`);const d=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}`;return fetch(d).then(s=>s.json()).then(s=>{if(!s||s.length===0)return console.error(`位置情報が見つかりませんでした: ${n}`),{lat:null,lon:null,log:o};const f=parseFloat(s[0].lat),v=parseFloat(s[0].lon);return r(n,f,v),{lat:f,lon:v,log:o}}).catch(s=>(console.error(`位置情報取得失敗: ${n}`,s),null))});Promise.all(g).then(o=>{p!=="world"&&o.forEach(n=>{if(n){const{lat:i,lon:d,log:s}=n;L.circleMarker([i,d],{radius:5,color:"#3366cc",fillColor:"#4a90e2",fillOpacity:.8}).addTo(t),l.extend([i,d])}})})});function M(t,a){const e="/travel-log-app".endsWith("/")?"/travel-log-app":"/travel-log-app/";fetch(`${e}world-110m.geojson`).then(p=>p.json()).then(p=>{L.geoJSON(p,{style:h=>{var c;const r=(c=h.id)==null?void 0:c.toUpperCase();return a.includes(r)?{fillColor:"#4a90e2",color:"#3366cc",weight:1,fillOpacity:.6}:{fillColor:"#e0e0e0",color:"#cccccc",weight:.5,fillOpacity:.2}},onEachFeature:(h,r)=>{var o;const c=JSON.parse(localStorage.getItem("travelLogs")||"[]"),l=(o=h.id)==null?void 0:o.toUpperCase(),g=c.filter(n=>n.country===l);g.length>0&&r.on("click",n=>{b(n.originalEvent,g)})}}).addTo(t)}).catch(p=>{console.error("世界地図の読み込みに失敗しました:",p)})}function J(){const t=JSON.parse(localStorage.getItem("travelLogs")||"[]"),a=new Set;return t.forEach(e=>{e.country&&a.add(e.country.toUpperCase())}),Array.from(a)}
