import"./style-DDcRjs_y.js";document.addEventListener("DOMContentLoaded",async()=>{await H();const g=document.getElementById("register-form"),f=document.getElementById("log-list"),v=document.getElementById("modal-root");b(),g.addEventListener("submit",async e=>{e.preventDefault();const c=new FormData(g),t=c.get("date"),a=c.get("title"),n=c.get("location"),o=c.get("memo");let s="UNK";try{const u=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}&addressdetails=1`,x=await(await fetch(u)).json();if(x.length>0&&x[0].address&&x[0].address.country_code){const m=x[0].address.country_code.toUpperCase();s=P(m)||m}}catch(u){console.error("国コードの取得に失敗しました",u);return}let l=null,i=null,r=null,d=null;if(s==="CHN"){const u=n.split(/[、,]/)[0].trim(),E=localStorage.getItem("cityProvinceLocationMapping")||"{}",m=JSON.parse(E)[u];if(m)l=m.province_zh,i=m.province_en,r=m.lat,d=m.lon;else if(!confirm("この都市はデータベースに存在しません。マッピングはできませんが、記録は続けますか？"))return}const p={id:Date.now(),date:t,title:a,location:n,memo:o,country:s,province_zh:l,province_en:i,lat:r,lon:d},h=JSON.parse(localStorage.getItem("travelLogs")||"[]");h.push(p),localStorage.setItem("travelLogs",JSON.stringify(h)),g.reset(),b()});function b(){const e=JSON.parse(localStorage.getItem("travelLogs")||"[]");e.sort((t,a)=>new Date(a.date)-new Date(t.date)),f.innerHTML="",f.className="flex flex-col gap-2";const c=document.createElement("div");c.className="h-6",f.appendChild(c),e.forEach(t=>{const a=document.createElement("div");a.className=`
        bg-white/10 backdrop-blur rounded-xl p-4 flex flex-col gap-2
        shadow border border-white/20 text-white/80
      `;const n=document.createElement("div");n.className="flex justify-between items-center";const o=document.createElement("h3");o.className="text-white font-semibold text-base",o.textContent=t.title;const s=document.createElement("span");s.className="text-sm text-white/60",s.textContent=t.date,n.appendChild(o),n.appendChild(s);const l=document.createElement("div");l.className="text-sm text-white/70",l.innerHTML=`<strong>場所：</strong> ${t.location}`;const i=document.createElement("div");i.className="text-sm text-white/60",i.textContent=t.memo?t.memo:"No data";const r=document.createElement("div");r.className="flex gap-2 mt-2";const d=document.createElement("button");d.textContent="編集",d.className="bg-blue-600 hover:bg-blue-500 text-white rounded px-3 py-1 text-sm transition",d.addEventListener("click",()=>J(t));const p=document.createElement("button");p.textContent="削除",p.className="bg-red-600 hover:bg-red-500 text-white rounded px-3 py-1 text-sm transition",p.addEventListener("click",()=>y(t.id,t.location)),r.appendChild(d),r.appendChild(p),a.appendChild(n),a.appendChild(l),a.appendChild(i),a.appendChild(r),f.appendChild(a)})}function y(e,c,t=!1){if(!t&&!confirm("本当にこの記録を削除しますか？"))return;const a=JSON.parse(localStorage.getItem("locationCache")||"{}");delete a[c],localStorage.setItem("locationCache",JSON.stringify(a));const n=D().filter(o=>o.id!==e);O(n),b()}function J(e){v.innerHTML="";const c=document.createElement("div");c.className="fixed inset-0 bg-black/60 backdrop-blur-sm flex justify-center items-center z-50",c.addEventListener("click",u=>{u.target===c&&w()});const t=document.createElement("div");t.className="bg-[#1f1f1f] rounded-xl p-6 max-w-sm w-full shadow-lg relative";const a=document.createElement("h2");a.className="text-lg font-bold mb-4 text-white/90",a.textContent="記録を編集";const n=document.createElement("form");n.className="flex flex-col gap-3";const o=document.createElement("input");o.type="date",o.name="date",o.value=e.date,o.required=!0,o.className="bg-white/10 backdrop-blur rounded-lg px-4 py-2 text-white/80 focus:ring focus:ring-blue-600 transition";const s=document.createElement("input");s.type="text",s.name="title",s.value=e.title,s.required=!0,s.className=o.className;const l=document.createElement("input");l.type="text",l.name="location",l.value=e.location,l.required=!0,l.className=o.className;const i=document.createElement("textarea");i.name="memo",i.rows=3,i.textContent=e.memo||"",i.className=o.className;const r=document.createElement("div");r.className="flex justify-end gap-2 mt-3";const d=document.createElement("button");d.textContent="削除",d.className="bg-red-600 hover:bg-red-500 text-white rounded px-4 py-2 text-sm transition",d.addEventListener("click",()=>{confirm("本当に削除しますか？")&&(y(e.id,e.location,!0),w())});const p=document.createElement("button");p.type="submit",p.textContent="保存",p.className="bg-blue-600 hover:bg-blue-500 text-white rounded px-4 py-2 text-sm transition",r.appendChild(p),r.appendChild(d),n.appendChild(o),n.appendChild(s),n.appendChild(l),n.appendChild(i),n.appendChild(r),n.addEventListener("submit",u=>{u.preventDefault();const E=o.value,x=s.value,m=l.value,k=i.value;let L=e.province_zh,S=e.province_en,M=e.lat,I=e.lon;if(m!==e.location)if(e.country==="CHN"){const N=m.split(/[、,]/)[0].trim(),z=localStorage.getItem("cityProvinceLocationMapping")||"{}",C=JSON.parse(z)[N];if(C)L=C.province_zh,S=C.province_en,M=C.lat,I=C.lon;else{alert("指定した都市がデータベースにありません。csvを更新してください。");return}}else L=e.province_zh,S=e.province_en,M=e.lat,I=e.lon;const B={...e,date:E,title:x,location:m,memo:k,province_zh:L,province_en:S,lat:M,lon:I},j=D().map(N=>N.id===e.id?B:N);O(j),w(),b()});const h=document.createElement("button");h.id="close-modal",h.className="absolute top-2 right-2 text-white/50 hover:text-white text-xl",h.innerHTML="&times;",h.addEventListener("click",w),t.appendChild(a),t.appendChild(n),t.appendChild(h),c.appendChild(t),v.appendChild(c)}function w(){v.innerHTML=""}function D(){return JSON.parse(localStorage.getItem("travelLogs")||"[]")}function O(e){localStorage.setItem("travelLogs",JSON.stringify(e))}});let _={};function H(){const f=`${"/travel-log-app".endsWith("/")?"/travel-log-app":"/travel-log-app/"}codes.json`;return console.log(`Loading country code map from: ${f}`),fetch(f).then(v=>v.json()).then(v=>{_={},v.forEach(([b,y])=>{_[b]=y})})}function P(g){return _[g.toUpperCase()]||null}
