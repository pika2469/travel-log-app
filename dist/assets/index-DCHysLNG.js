(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))p(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&p(c)}).observe(document,{childList:!0,subtree:!0});function e(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function p(t){if(t.ep)return;t.ep=!0;const n=e(t);fetch(t.href,n)}})();function _(){if(localStorage.getItem("cityProvinceLocationMapping")){console.log("キャッシュはすでに存在しています");return}fetch("./china_cities.csv").then(o=>o.text()).then(o=>{const i={},e=o.split(`
`),p=e[0].split(",").map(t=>t.trim());for(let t=1;t<e.length;t++){const n=e[t].split(",").map(a=>a.trim());if(n.length!==p.length)continue;const c={};p.forEach((a,y)=>{c[a]=n[y]});const d=c.city_name_zh,f=c.city_name_zh2,r=c.province_name_zh,l=c.province_name_en,s=parseFloat(c.Latitude),u=parseFloat(c.Longitude);d&&(i[d]={province_zh:r,province_en:l,lat:s,lon:u}),f&&(i[f]={province_zh:r,province_en:l,lat:s,lon:u})}localStorage.setItem("cityProvinceLocationMapping",JSON.stringify(i)),console.log("map.js側で都市と省のキャッシュを初期化しました")}).catch(o=>console.error("csvの読込に失敗しました:",o))}function O(o){o.eachLayer(i=>{o.removeLayer(i)}),L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors, © CARTO"}).addTo(o)}function w(o,i){let e=document.getElementById("info-popup");if(e&&e.remove(),i.length===0)return;e=document.createElement("div"),e.id="info-popup",e.style.position="absolute",e.style.backgroundColor="rgba(0,0,0,0.85)",e.style.border="1px solid #444",e.style.color="white",e.style.borderRadius="8px",e.style.padding="10px",e.style.MaxWidth="90%",e.style.maxHeight="300px",e.style.overflowY="auto",e.style.display="flex",e.style.flexDirection="column",e.style.gap="10px",e.style.zIndex=1e3,document.body.appendChild(e);const{x:p,y:t}=o;e.style.left=`${p}px`,e.style.top=`${t}px`,i.forEach(n=>{const c=document.createElement("div");c.className="log-card",c.style.backgorundColor="#4a90e2",c.style.color="black",c.style.padding="10px",c.style.borderRadius="6px";const d=document.createElement("div");d.style.display="flex",d.style.gap="10px",d.style.alignItems="center";const f=document.createElement("span");f.textContent=n.date;const r=document.createElement("span");r.textContent=n.location.split("、")[0],d.appendChild(f),d.appendChild(r),c.appendChild(d),e.appendChild(c)}),setTimeout(()=>{document.addEventListener("click",function n(c){e.contains(c.target)||(e.remove(),document.removeEventListener("click",n))})},10)}_();document.addEventListener("DOMContentLoaded",()=>{const o=L.map("map").setView([36.2048,138.2529],2);O(o);const i=document.createElement("div");i.id="info-panel",document.body.appendChild(i);const e=document.querySelectorAll(".mode-buttons button");let p="";e.forEach(r=>{r.addEventListener("click",()=>{const l=r.dataset.mode;switch(p=l,e.forEach(s=>s.classList.remove("active")),r.classList.add("active"),l){case"world":o.setView([36.2048,138.2529],2),O(o);const s=P();I(o,s);break;case"china":o.setView([35.817,104.1954],4),O(o);const u=JSON.parse(localStorage.getItem("travelLogs")||"[]"),a=JSON.parse(localStorage.getItem("cityProvinceLocationMapping")||"{}"),y=new Set,C=[];u.forEach(h=>{if(!h.location.includes("中国"))return;const m=h.location.split("、")[0],g=a[m];if(!g)return;const{lat:v,lon:S,province_zh:E,province_en:b}=g;y.add(b),v&&S&&C.push({lat:v,lon:S,city:m,province_zh:E})}),C.forEach(({lat:h,lon:m,city:g,province_zh:v})=>{L.circleMarker([h,m],{radius:6,fillColor:"#4a90e2",color:"#3366cc",weight:1,opacitiy:1,fillOpacity:.6}).addTo(o).bindPopup(`<strong>${g}</strong><br>${v}`)}),fetch("./china-province.geojson").then(h=>h.json()).then(h=>{L.geoJSON(h,{style:m=>{const g=m.properties.name;return y.has(g)?{fillColor:"#4a90e2",color:"#3366cc",weight:1,fillOpacity:.6}:{fillColor:"#e0e0e0",color:"#cccccc",weight:.5,fillOpacity:.2}},onEachFeature:(m,g)=>{g.on("click",v=>{const S=m.properties.name,E=u.filter(b=>{const N=b.location.split("、")[0],x=a[N];return x&&x.province_en===S});w(v.originalEvent,E)})}}).addTo(o)}).catch(h=>{console.error("中国地図のGeoJSON読込に失敗しました:",h)}),console.log("中国地図がtravelLogsに基いてGeoJSONで描画されました");break;case"japan":o.setView([36.2048,138.2539],5),O(o);break}})});function t(r){return JSON.parse(localStorage.getItem("locationCache")||"{}")[r]||null}function n(r,l,s){const u=JSON.parse(localStorage.getItem("locationCache")||"{}");u[r]={lat:l,lon:s},localStorage.setItem("locationCache",JSON.stringify(u))}const c=JSON.parse(localStorage.getItem("travelLogs")||"[]"),d=L.latLngBounds(),f=c.map(r=>{const l=r.location,s=t(l);if(s)return console.log(`キャッシュヒット: ${l}`),Promise.resolve({lat:s.lat,lon:s.lon,log:r});console.log(`キャッシュミス: ${l}`);const u=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(l)}`;return fetch(u).then(a=>a.json()).then(a=>{if(!a||a.length===0)return console.error(`位置情報が見つかりませんでした: ${l}`),{lat:null,lon:null,log:r};const y=parseFloat(a[0].lat),C=parseFloat(a[0].lon);return n(l,y,C),{lat:y,lon:C,log:r}}).catch(a=>(console.error(`位置情報取得失敗: ${l}`,a),null))});Promise.all(f).then(r=>{p!=="world"&&r.forEach(l=>{if(l){const{lat:s,lon:u,log:a}=l;L.circleMarker([s,u],{radius:5,color:"#3366cc",fillColor:"#4a90e2",fillOpacity:.8}).addTo(o),d.extend([s,u])}})})});function I(o,i){fetch("./world-110m.geojson").then(e=>e.json()).then(e=>{L.geoJSON(e,{style:p=>{var n;const t=(n=p.id)==null?void 0:n.toUpperCase();return i.includes(t)?{fillColor:"#4a90e2",color:"#3366cc",weight:1,fillOpacity:.6}:{fillColor:"#e0e0e0",color:"#cccccc",weight:.5,fillOpacity:.2}},onEachFeature:(p,t)=>{var f;const n=JSON.parse(localStorage.getItem("travelLogs")||"[]"),c=(f=p.id)==null?void 0:f.toUpperCase(),d=n.filter(r=>r.country===c);d.length>0&&t.on("click",r=>{w(r.originalEvent,d)})}}).addTo(o)}).catch(e=>{console.error("世界地図の読み込みに失敗しました:",e)})}function P(){const o=JSON.parse(localStorage.getItem("travelLogs")||"[]"),i=new Set;return o.forEach(e=>{e.country&&i.add(e.country.toUpperCase())}),Array.from(i)}
